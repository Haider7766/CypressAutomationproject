trigger:
  branches:
    include:
      - '*'   # Run Cypress for all branches

stages:
- stage: RunCypress
  displayName: "Cypress Test Stage"
  jobs:
  - job: CypressJob
    displayName: "Run Cypress Tests"
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: 'Install Node.js'

    - task: CmdLine@2
      displayName: 'Install dependencies'
      inputs:
        script: npm ci

    - task: PowerShell@2
      displayName: 'Ensure report folders exist'
      condition: always()
      inputs:
        targetType: inline
        script: |
          New-Item -ItemType Directory -Force -Path "cypress/reports/mochawesome" | Out-Null
          New-Item -ItemType Directory -Force -Path "cypress/screenshots" | Out-Null
          New-Item -ItemType Directory -Force -Path "cypress/videos" | Out-Null

    - task: CmdLine@2
      displayName: 'Run Cypress Tests'
      inputs:
        script: npx cypress run --reporter cypress-multi-reporters --reporter-options configFile=reporter-config.json

    - task: CmdLine@2
      displayName: 'Merge Mochawesome JSON and Generate HTML'
      condition: always()
      inputs:
        script: |
          npx mochawesome-merge cypress/reports/*.json > cypress/reports/mochawesome/merged-report.json
          npx marge cypress/reports/mochawesome/merged-report.json --reportDir cypress/reports/mochawesome --inline

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Mochawesome Reports'
      condition: always()
      inputs:
        PathtoPublish: 'cypress/reports/mochawesome'
        ArtifactName: 'mochawesome-html-report'
        publishLocation: 'Container'
